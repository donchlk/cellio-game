<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cell.io - Enhanced Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #0b0b0b; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; pointer-events: none; }
        #leaderboard { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: #fff; padding: 15px; border-radius: 8px; min-width: 180px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        #minimap { position: absolute; bottom: 20px; right: 20px; width: 150px; height: 150px; background: rgba(0,0,0,0.5); border: 1px solid #444; border-radius: 4px; }
        #start-screen, #death-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #fff; z-index: 100; backdrop-filter: blur(10px); }
        input { padding: 12px; font-size: 18px; border-radius: 5px; border: none; margin-bottom: 20px; text-align: center; }
        button { padding: 12px 30px; font-size: 20px; cursor: pointer; background: #007bff; color: #fff; border: none; border-radius: 5px; transition: 0.2s; }
        button:hover { background: #0056b3; transform: scale(1.05); }
        .stat { font-size: 18px; margin-bottom: 5px; }
    </style>
</head>
<body>
<div id="ui">
    <div class="stat">Mass: <span id="mass">0</span></div>
    <div class="stat">Score: <span id="score">0</span></div>
</div>
<div id="leaderboard">
    <div style="text-align:center; font-weight:bold; margin-bottom:10px;">Leaderboard</div>
    <div id="lb-list"></div>
</div>
<canvas id="minimap"></canvas>
<div id="start-screen">
    <h1>Cell.io</h1>
    <input type="text" id="name-input" placeholder="Your Nickname" maxlength="12">
    <button onclick="startGame()">Play</button>
    <p style="margin-top: 20px; color: #888;">[Space] Split | [W] Eject Mass</p>
</div>
<div id="death-screen" style="display:none;">
    <h1 style="color: #ff4444;">Game Over</h1>
    <p id="final-stats"></p>
    <button onclick="location.reload()">Try Again</button>
</div>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game"), ctx = canvas.getContext("2d");
const mCanvas = document.getElementById("minimap"), mCtx = mCanvas.getContext("2d");
const WORLD_SIZE = 4000, FOOD_COUNT = 800, BOT_COUNT = 15;
const COLORS = ["#ff5e5e", "#5eff5e", "#5e5eff", "#ffff5e", "#ff5eff", "#5effff", "#ffae5e"];
let player = null, cells = [], food = [], particles = [], camera = { x: 2000, y: 2000, z: 1 }, mouse = { x: 0, y: 0 }, lastUpdate = Date.now();

class Cell {
    constructor(x, y, r, c, n, owner = null) {
        this.x = x; this.y = y; this.r = r; this.c = c; this.n = n; this.owner = owner;
        this.pulse = Math.random() * Math.PI * 2;
    }
    draw() {
        this.pulse += 0.05;
        const wobble = Math.sin(this.pulse) * (this.r * 0.02);
        ctx.save();
        ctx.fillStyle = this.c;
        ctx.beginPath();
        for(let i=0; i<8; i++) {
            let a = (i/8)*Math.PI*2; let pr = this.r + (i%2?wobble:-wobble);
            ctx.lineTo(this.x + Math.cos(a)*pr, this.y + Math.sin(a)*pr);
        }
        ctx.closePath(); ctx.fill();
        const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.r);
        grad.addColorStop(0.8, "transparent"); grad.addColorStop(1, "rgba(255,255,255,0.2)");
        ctx.fillStyle = grad; ctx.fill();
        ctx.restore();
        if (this.n && this.r > 15) {
            ctx.fillStyle = "#fff"; ctx.textAlign = "center";
            ctx.font = `bold ${Math.max(12, this.r/2.5)}px sans-serif`;
            ctx.fillText(this.n, this.x, this.y + this.r/6);
        }
    }
}

function spawnFood() { food.push({ x: Math.random()*WORLD_SIZE, y: Math.random()*WORLD_SIZE, r: 5, c: COLORS[Math.floor(Math.random()*COLORS.length)] }); }
function spawnBot() {
    const names = ["Botzilla", "Rex", "Blobby", "Hunter", "Tiny", "Swift"];
    cells.push(new Cell(Math.random()*WORLD_SIZE, Math.random()*WORLD_SIZE, 30, COLORS[Math.floor(Math.random()*COLORS.length)], names[Math.floor(Math.random()*names.length)]));
}

function startGame() {
    const name = document.getElementById("name-input").value || "Player";
    document.getElementById("start-screen").style.display = "none";
    player = new Cell(WORLD_SIZE/2, WORLD_SIZE/2, 30, "#fff", name, "player");
    cells.push(player);
    for(let i=0; i<FOOD_COUNT; i++) spawnFood();
    for(let i=0; i<BOT_COUNT; i++) spawnBot();
    requestAnimationFrame(gameLoop);
}

function gameLoop() {
    const now = Date.now(); const dt = (now - lastUpdate) / 1000; lastUpdate = now;
    update(dt); draw(); requestAnimationFrame(gameLoop);
}

function update(dt) {
    const playerPieces = cells.filter(c => c.owner === "player");
    cells.forEach(c => {
        const speed = 150 / Math.sqrt(c.r);
        let tx, ty;
        if (c.owner === "player") {
            tx = mouse.x - canvas.width/2; ty = mouse.y - canvas.height/2;
            const dist = Math.hypot(tx, ty);
            if (dist > 10) { c.x += (tx / dist) * speed; c.y += (ty / dist) * speed; }
        } else {
            if (!c.target || Math.hypot(c.x - c.target.x, c.y - c.target.y) < 50) c.target = food[Math.floor(Math.random()*food.length)];
            const d = Math.hypot(c.target.x - c.x, c.target.y - c.y);
            c.x += ((c.target.x - c.x) / d) * speed; c.y += ((c.target.y - c.y) / d) * speed;
        }
        c.x = Math.max(c.r, Math.min(WORLD_SIZE - c.r, c.x));
        c.y = Math.max(c.r, Math.min(WORLD_SIZE - c.r, c.y));
        if (c.r > 20) c.r -= c.r * 0.0005 * dt;
    });

    food.forEach((f, i) => {
        cells.forEach(c => {
            if (Math.hypot(c.x - f.x, c.y - f.y) < c.r) {
                c.r = Math.sqrt(c.r*c.r + f.r*f.r);
                food[i] = { x: Math.random()*WORLD_SIZE, y: Math.random()*WORLD_SIZE, r: 5, c: COLORS[Math.floor(Math.random()*COLORS.length)] };
                if (c.owner === "player") { for(let j=0; j<3; j++) particles.push({ x: f.x, y: f.y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, c: f.c, life: 1 }); }
            }
        });
    });

    for (let i = cells.length - 1; i >= 0; i--) {
        for (let j = cells.length - 1; j >= 0; j--) {
            if (i === j) continue;
            let a = cells[i], b = cells[j]; if (!a || !b) continue;
            const d = Math.hypot(a.x - b.x, a.y - b.y);
            if (a.r > b.r * 1.15 && d < a.r - b.r * 0.3) {
                a.r = Math.sqrt(a.r*a.r + b.r*b.r);
                if (b.owner === "player" && cells.filter(c => c.owner === "player").length === 1) gameOver();
                cells.splice(j, 1); if (!b.owner) setTimeout(spawnBot, 5000);
            }
        }
    }

    if (playerPieces.length > 0) {
        let avgX = 0, avgY = 0, totalR = 0;
        playerPieces.forEach(p => { avgX += p.x; avgY += p.y; totalR += p.r; });
        camera.x = avgX / playerPieces.length; camera.y = avgY / playerPieces.length;
        camera.z = Math.pow(40 / (totalR / playerPieces.length), 0.4);
        const mass = Math.floor(playerPieces.reduce((sum, p) => sum + p.r*p.r/10, 0));
        document.getElementById("mass").innerText = mass;
        document.getElementById("score").innerText = Math.max(parseInt(document.getElementById("score").innerText), mass);
    }
    particles = particles.filter(p => { p.x += p.vx; p.y += p.vy; p.life -= 0.05; return p.life > 0; });
}

function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(camera.z, camera.z); ctx.translate(-camera.x, -camera.y);
    ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 2;
    for(let x=0; x<=WORLD_SIZE; x+=100) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,WORLD_SIZE); ctx.stroke(); }
    for(let y=0; y<=WORLD_SIZE; y+=100) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(WORLD_SIZE,y); ctx.stroke(); }
    ctx.strokeStyle = "#ff4444"; ctx.lineWidth = 5; ctx.strokeRect(0, 0, WORLD_SIZE, WORLD_SIZE);
    food.forEach(f => { ctx.fillStyle = f.c; ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill(); });
    particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill(); });
    cells.sort((a,b) => a.r - b.r).forEach(c => c.draw());
    ctx.restore();
    
    mCanvas.width = 150; mCanvas.height = 150; const s = 150 / WORLD_SIZE;
    mCtx.fillStyle = "rgba(255,255,255,0.1)"; mCtx.fillRect(0,0,150,150);
    cells.forEach(c => { mCtx.fillStyle = c.owner === "player" ? "#fff" : c.c; mCtx.beginPath(); mCtx.arc(c.x*s, c.y*s, Math.max(1, c.r*s), 0, Math.PI*2); mCtx.fill(); });
    
    const sorted = cells.filter(c => c.n).sort((a,b) => b.r - a.r).slice(0, 5);
    document.getElementById("lb-list").innerHTML = sorted.map((c, i) => `<div style="color:${c.owner==='player'?'#fff':'#aaa'}">${i+1}. ${c.n}</div>`).join("");
}

function gameOver() {
    document.getElementById("death-screen").style.display = "flex";
    document.getElementById("final-stats").innerText = `Final Score: ${document.getElementById("score").innerText}`;
}

window.onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY; };
window.onkeydown = e => {
    if (e.code === "Space" && player) {
        cells.filter(c => c.owner === "player").forEach(p => {
            if (p.r > 35) {
                p.r /= 1.414; const a = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
                cells.push(new Cell(p.x + Math.cos(a)*p.r*2, p.y + Math.sin(a)*p.r*2, p.r, p.c, p.n, "player"));
            }
        });
    }
};
</script>
</body>
</html>
